<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telares - OCR REAL</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        :root {
            --primary-color: #0f4c75;
            --secondary-color: #3282b8;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #1b262c;
            --border-radius: 6px;
            --status-working-bg: #28a745; 
            --status-working-text: #ffffff;
            --status-stopped-bg: #ffc107; 
            --status-stopped-text: #000000;
            --card-height: 140px; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

        header {
            background-color: var(--primary-color); color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .controls-bar {
            background: white; padding: 15px 20px; display: flex; gap: 15px;
            align-items: flex-end; border-bottom: 1px solid #ddd; flex-wrap: wrap;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.75rem; color: #666; margin-bottom: 4px; font-weight: bold; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; color: white; transition: 0.2s; }
        .btn-green { background-color: #28a745; } .btn-green:hover { background-color: #218838; }
        .btn-blue { background-color: var(--secondary-color); } .btn-blue:hover { background-color: #0f4c75; }
        .btn-cancel { background: #6c757d; color: white; }

        .plant-scroll-area { flex: 1; overflow: auto; padding: 20px; }
        .plant-grid {
            display: flex; gap: 12px; min-width: 1600px; align-items: flex-start;
        }
        .plant-column {
            flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 160px;
        }

        .telar-card, .empty-card-space {
            height: var(--card-height); border-radius: var(--border-radius);
        }
        .empty-card-space {
            background: transparent; border: 1px dashed rgba(0,0,0,0.05); pointer-events: none;
        }
        .telar-card {
            background: white; border: 1px solid #e0e0e0; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s;
            display: flex; flex-direction: column;
        }
        .telar-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-color: var(--secondary-color); }

        .card-top { padding: 8px 10px; display: flex; justify-content: space-between; font-weight: bold; font-size: 0.85rem; }
        .card-status-bar { text-align: center; padding: 4px 0; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-working { background-color: var(--status-working-bg); color: var(--status-working-text); }
        .status-paused { background-color: var(--status-stopped-bg); color: var(--status-stopped-text); }
        .status-pending { background-color: #e9ecef; color: #495057; }

        .card-body { padding: 8px 10px; flex: 1; font-size: 0.8rem; color: #555; display: flex; flex-direction: column; justify-content: center; }
        .card-body strong { display: block; color: #000; font-size: 0.95rem; margin-bottom: 2px; }
        .card-footer { padding: 8px 10px; font-size: 0.7rem; color: #888; border-top: 1px solid #f0f0f0; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .full-width { grid-column: span 2; }
        textarea { width: 100%; height: 60px; padding: 8px; border: 1px solid #ccc; }
        
        .img-preview-container { margin-top: 10px; text-align: center; display: none; }
        .img-preview-container img { max-width: 100%; max-height: 250px; border-radius: 8px; border: 2px solid #ddd; }
        
        .ocr-controls {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;
        }
        .ocr-controls h4 {
            margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
        }
        .capture-buttons {
            display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;
        }
        .btn-capture {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-size: 0.85rem; transition: all 0.2s;
        }
        .btn-capture:hover {
            background: rgba(255,255,255,0.3); transform: scale(1.02);
        }
        .btn-capture:disabled {
            opacity: 0.6; pointer-events: none;
        }
        
        .processing-indicator {
            display: none; background: #e7f3ff; border: 1px solid #b3d9ff; 
            border-radius: 6px; padding: 12px; margin: 10px 0; text-align: center;
        }
        
        .results-container {
            background: #d4edda; border: 1px solid #c3e6cb;
            border-radius: 6px; padding: 12px; margin: 10px 0; display: none;
        }
        
        .analysis-details {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;
            padding: 12px; margin: 10px 0; display: none; font-size: 0.85rem;
        }
        
        .manual-input {
            background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;
            padding: 12px; margin: 10px 0; display: none;
        }
        
        .real-ocr-indicator {
            color: #dc3545; font-weight: bold; font-size: 0.85rem; 
            background: #f8d7da; padding: 4px 8px; border-radius: 4px; display: inline-block;
        }
        
        .progress-bar {
            width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #dc3545, #c82333);
            width: 0%; transition: width 0.3s ease;
        }
        
        .text-found {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;
            padding: 8px; margin: 5px 0; font-family: monospace; font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <header>
        <div>
            <h3>Lectura de Telares <span class="real-ocr-indicator">üëÅÔ∏è OCR REAL</span></h3>
            <small style="opacity: 0.8;">Tesseract.js - Lee texto real</small>
        </div>
        <div id="current-time" style="font-size: 1rem; font-weight: bold;">--:--</div>
    </header>

    <div class="controls-bar">
        <div class="control-group">
            <label>Fecha Turno</label>
            <input type="date" id="filter-date">
        </div>
        <div class="control-group">
            <label>Turno</label>
            <select id="filter-turno">
                <option value="M">Ma√±ana</option>
                <option value="N">Noche</option>
                <option value="F">Festivo</option>
            </select>
        </div>
        
        <div style="flex-grow: 1;"></div>
        
        <button class="btn btn-green" onclick="exportToCSV()">CSV</button>
        <div style="margin-left: 15px; font-weight: bold; color: var(--primary-color);" id="progress-text">0/31</div>
    </div>

    <div class="plant-scroll-area">
        <div class="plant-grid" id="plant-grid"></div>
    </div>

    <div class="modal-overlay" id="modal-registro">
        <div class="modal-content">
            <h2 id="modal-title" style="color: var(--primary-color);">Registro</h2>
            <p id="modal-subtitle" style="color:#666; font-size:0.9rem; margin-bottom:10px; border-bottom: 1px solid #eee; padding-bottom: 10px;"></p>
            
            <form id="form-lectura">
                
                <div class="ocr-controls">
                    <h4>üëÅÔ∏è OCR Real - Lee texto de verdad</h4>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 10px;">
                        Usa Tesseract.js para leer texto real de la imagen. NO inventa valores.
                    </p>
                    
                    <div class="capture-buttons">
                        <input type="file" id="inp-foto-ai" accept="image/*" capture="environment" style="display: none;">
                        <label for="inp-foto-ai" class="btn-capture">üì∑ Tomar Foto</label>
                        <input type="file" id="inp-foto-galeria" accept="image/*" style="display: none;">
                        <label for="inp-foto-galeria" class="btn-capture">üñºÔ∏è Galer√≠a</label>
                        <button type="button" class="btn-capture" id="analyze-btn" onclick="runRealOCR()">üëÅÔ∏è Leer Texto</button>
                        <button type="button" class="btn-capture" onclick="enableManualInput()">‚úèÔ∏è Manual</button>
                        <button type="button" class="btn-capture" onclick="clearOCRData()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>
                
                <div id="preview-container-ai" class="img-preview-container">
                    <img id="img-preview-ai" alt="Preview">
                </div>
                
                <div id="processing-indicator" class="processing-indicator">
                    <div style="margin-bottom: 8px;">
                        <span id="processing-text">Leyendo texto...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
                
                <div id="analysis-details" class="analysis-details">
                    <h6 style="margin-bottom: 8px;">üëÅÔ∏è Texto Encontrado:</h6>
                    <div id="text-found"></div>
                </div>
                
                <div id="results-container" class="results-container">
                    <h5 style="color: #155724; margin-bottom: 8px;">‚úÖ N√∫meros Extra√≠dos:</h5>
                    <div id="detected-data"></div>
                </div>
                
                <div id="manual-input" class="manual-input">
                    <h5 style="margin-bottom: 8px;">‚úèÔ∏è Entrada Manual</h5>
                    <p style="font-size: 0.9rem;">No se encontr√≥ texto o no se detectaron n√∫meros.</p>
                </div>
                
                <div class="form-grid">
                    <div>
                        <label>Operador</label>
                        <input type="text" id="inp-operador" placeholder="Nombre" required>
                    </div>
                    <div>
                        <label>RPM</label>
                        <input type="number" id="inp-rpm" placeholder="0" min="0" max="1000" required>
                    </div>
                    <div>
                        <label>Pasadas / Picks</label>
                        <input type="number" id="inp-picks" placeholder="0" min="0" required>
                    </div>
                    <div>
                        <label>Metros</label>
                        <input type="number" id="inp-metros" placeholder="0" min="0" step="0.01">
                    </div>
                    <div class="full-width">
                        <label>Observaciones</label>
                        <textarea id="inp-observaciones" placeholder="Notas adicionales..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-green">üíæ Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // DATOS y ESTADO
    const telares = [
        {id: 1, pos: [0,0]}, {id: 2, pos: [0,1]}, {id: 3, pos: [0,2]}, {id: 4, pos: [0,3]},
        {id: 5, pos: [1,0]}, {id: 6, pos: [1,1]}, {id: 7, pos: [1,2]}, {id: 8, pos: [1,3]},
        {id: 9, pos: [2,0]}, {id: 10, pos: [2,1]}, {id: 11, pos: [2,2]}, {id: 12, pos: [2,3]},
        {id: 13, pos: [3,0]}, {id: 14, pos: [3,1]}, {id: 15, pos: [3,2]}, {id: 16, pos: [3,3]},
        {id: 17, pos: [4,0]}, {id: 18, pos: [4,1]}, {id: 19, pos: [4,2]}, {id: 20, pos: [4,3]},
        {id: 21, pos: [5,0]}, {id: 22, pos: [5,1]}, {id: 23, pos: [5,2]}, {id: 24, pos: [5,3]},
        {id: 25, pos: [6,0]}, {id: 26, pos: [6,1]}, {id: 27, pos: [6,2]}, {id: 28, pos: [6,3]},
        {id: 29, pos: [7,0]}, {id: 30, pos: [7,1]}, {id: 31, pos: [8,0]}
    ];

    const appState = {
        fecha: new Date().toISOString().split('T')[0],
        turno: 'M',
        lecturas: JSON.parse(localStorage.getItem('lecturasDB_v2') || '[]'),
        operador: localStorage.getItem('lastOperador') || '',
        selectedTelar: null,
        currentImageData: null,
        accumulatedData: { rpm: null, picks: null }
    };

    // Elements
    const elDate = document.getElementById('filter-date');
    const elTurno = document.getElementById('filter-turno');
    const inpOperador = document.getElementById('inp-operador');
    const inpFotoAI = document.getElementById('inp-foto-ai');
    const inpFotoGaleria = document.getElementById('inp-foto-galeria');
    const imgPreviewAI = document.getElementById('img-preview-ai');

    // Init
    elDate.value = appState.fecha;
    elTurno.value = appState.turno;
    inpOperador.value = appState.operador;

    // --- RENDER PLANT ---
    function renderPlant() {
        const grid = document.getElementById('plant-grid');
        grid.innerHTML = '';

        for(let col = 0; col < 9; col++) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'plant-column';
            
            for(let row = 0; row < 4; row++) {
                const telar = telares.find(t => t.pos[0] === col && t.pos[1] === row);
                
                if(telar) {
                    const lectura = appState.lecturas.find(l => 
                        l.telarId === telar.id && 
                        l.fecha === appState.fecha && 
                        l.turno === appState.turno
                    );
                    
                    const card = document.createElement('div');
                    card.className = 'telar-card';
                    card.onclick = () => openModal(telar.id);
                    
                    let statusClass = lectura ? (lectura.rpm > 0 ? 'status-working' : 'status-paused') : 'status-pending';
                    let statusText = lectura ? (lectura.rpm > 0 ? 'TRABAJANDO' : 'PARADO') : 'SIN DATOS';
                    
                    card.innerHTML = `
                        <div class="card-top">
                            <span>TELAR ${telar.id}</span>
                            <span>${lectura ? lectura.rpm + ' RPM' : '--'}</span>
                        </div>
                        <div class="card-status-bar ${statusClass}">${statusText}</div>
                        <div class="card-body">
                            <strong>${lectura ? new Intl.NumberFormat().format(lectura.picks) + ' picks' : 'Sin lecturas'}</strong>
                            ${lectura ? `Operador: ${lectura.operador}` : ''}
                        </div>
                        <div class="card-footer">${lectura ? `Metros: ${lectura.metros || 0}` : 'Pendiente'}</div>
                    `;
                    columnDiv.appendChild(card);
                } else {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'empty-card-space';
                    columnDiv.appendChild(emptyCard);
                }
            }
            grid.appendChild(columnDiv);
        }

        const completadas = appState.lecturas.filter(l => l.fecha === appState.fecha && l.turno === appState.turno).length;
        document.getElementById('progress-text').innerText = `${completadas}/31`;
    }

    // --- MODAL CONTROLS ---
    function openModal(telarId) {
        appState.selectedTelar = telarId;
        const modal = document.getElementById('modal-registro');
        document.getElementById('modal-title').innerText = `Telar ${telarId}`;
        document.getElementById('modal-subtitle').innerText = `${appState.fecha} - Turno ${appState.turno}`;
        
        const lectura = appState.lecturas.find(l => l.telarId === telarId && l.fecha === appState.fecha && l.turno === appState.turno);
        if(lectura) {
            document.getElementById('inp-operador').value = lectura.operador;
            document.getElementById('inp-rpm').value = lectura.rpm;
            document.getElementById('inp-picks').value = lectura.picks;
            document.getElementById('inp-metros').value = lectura.metros || '';
            document.getElementById('inp-observaciones').value = lectura.observaciones || '';
        } else {
            document.getElementById('form-lectura').reset();
            document.getElementById('inp-operador').value = appState.operador;
        }
        
        // Reset accumulated data for new telar
        appState.accumulatedData = { rpm: null, picks: null };
        clearOCRData();
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-registro').style.display = 'none';
        appState.selectedTelar = null;
        appState.accumulatedData = { rpm: null, picks: null };
    }

    // --- FORM SUBMISSION ---
    document.getElementById('form-lectura').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const op = document.getElementById('inp-operador').value.trim();
        const rpm = parseInt(document.getElementById('inp-rpm').value) || 0;
        const picks = parseInt(document.getElementById('inp-picks').value) || 0;
        const metros = parseFloat(document.getElementById('inp-metros').value) || 0;
        const obs = document.getElementById('inp-observaciones').value.trim();
        
        if(!op) { alert("Falta el operador"); return; }

        const newRecord = {
            telarId: appState.selectedTelar,
            fecha: appState.fecha,
            turno: appState.turno,
            operador: op,
            rpm: rpm,
            picks: picks,
            metros: metros,
            observaciones: obs,
            timestamp: new Date().toISOString()
        };

        const existingIdx = appState.lecturas.findIndex(l => 
            l.telarId === appState.selectedTelar && 
            l.fecha === appState.fecha && 
            l.turno === appState.turno
        );

        if(existingIdx >= 0) appState.lecturas[existingIdx] = newRecord;
        else appState.lecturas.push(newRecord);

        localStorage.setItem('lecturasDB_v2', JSON.stringify(appState.lecturas));
        localStorage.setItem('lastOperador', op);
        appState.operador = op;

        closeModal();
        renderPlant();
    });

    // Listeners Filtros
    elDate.addEventListener('change', (e) => { appState.fecha = e.target.value; renderPlant(); });
    elTurno.addEventListener('change', (e) => { appState.turno = e.target.value; renderPlant(); });

    // --- OCR REAL CON TESSERACT ---
    
    // File input handlers
    inpFotoAI.addEventListener('change', handleImageSelection);
    inpFotoGaleria.addEventListener('change', handleImageSelection);

    function handleImageSelection(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            imgPreviewAI.src = evt.target.result;
            appState.currentImageData = evt.target.result;
            document.getElementById('preview-container-ai').style.display = 'block';
            
            hideAllResultSections();
        };
        reader.readAsDataURL(file);
    }

    function hideAllResultSections() {
        document.getElementById('processing-indicator').style.display = 'none';
        document.getElementById('analysis-details').style.display = 'none';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('manual-input').style.display = 'none';
    }

    async function runRealOCR() {
        if (!appState.currentImageData) {
            alert("Por favor selecciona una imagen primero");
            return;
        }

        const processingEl = document.getElementById('processing-indicator');
        const processingText = document.getElementById('processing-text');
        const progressFill = document.getElementById('progress-fill');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisDetails = document.getElementById('analysis-details');
        const textFoundEl = document.getElementById('text-found');
        
        hideAllResultSections();
        processingEl.style.display = 'block';
        analysisDetails.style.display = 'block';
        analyzeBtn.disabled = true;
        
        try {
            progressFill.style.width = '25%';
            processingText.textContent = "Inicializando Tesseract...";
            await delay(200);
            
            progressFill.style.width = '50%';
            processingText.textContent = "Leyendo texto de la imagen...";
            
            // USAR TESSERACT.JS PARA LEER TEXTO REAL
            const { data: { text } } = await Tesseract.recognize(
                appState.currentImageData,
                'spa', // Spanish language
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.min(50 + (m.progress * 40), 90);
                            progressFill.style.width = progress + '%';
                            processingText.textContent = `Leyendo texto... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                }
            );
            
            progressFill.style.width = '100%';
            processingText.textContent = "Extrayendo n√∫meros...";
            
            // Mostrar texto encontrado
            textFoundEl.innerHTML = `<div class="text-found">${text.replace(/\n/g, '<br>')}</div>`;
            
            // EXTRAER N√öMEROS REALES DEL TEXTO
            const numbers = extractRealNumbers(text);
            
            await delay(500);
            processingEl.style.display = 'none';
            
            if (numbers.length > 0) {
                displayRealResults(numbers, text);
                updateAccumulatedData(numbers);
            } else {
                displayNoNumbersFound(text);
            }
            
        } catch (error) {
            console.error("Error en OCR:", error);
            processingText.textContent = "Error en OCR";
            textFoundEl.innerHTML = `<span style="color: #dc3545;">ERROR: ${error.message}</span>`;
            setTimeout(() => {
                processingEl.style.display = 'none';
                enableManualInput();
            }, 2000);
        } finally {
            analyzeBtn.disabled = false;
            progressFill.style.width = '0%';
        }
    }

    function extractRealNumbers(text) {
        // Buscar patrones espec√≠ficos en el texto
        const numbers = [];
        
        // Limpiar texto
        const cleanText = text.replace(/[^\w\s\d]/g, ' ').toLowerCase();
        
        // Buscar RPM
        const rpmMatches = cleanText.match(/(\d+)\s*rpm/i);
        if (rpmMatches) {
            numbers.push({
                type: 'rpm',
                value: parseInt(rpmMatches[1]),
                context: rpmMatches[0]
            });
        }
        
        // Buscar n√∫meros grandes (posibles pasadas/contadores)
        const largeNumbers = text.match(/\d{3,}/g);
        if (largeNumbers) {
            largeNumbers.forEach(num => {
                const value = parseInt(num);
                if (value > 100 && value < 10000000) { // Rango razonable
                    numbers.push({
                        type: 'counter',
                        value: value,
                        context: num
                    });
                }
            });
        }
        
        // Buscar porcentajes
        const percentMatches = text.match(/(\d+(?:\.\d+)?)\s*%/g);
        if (percentMatches) {
            percentMatches.forEach(match => {
                const value = parseFloat(match.replace('%', ''));
                numbers.push({
                    type: 'percentage',
                    value: value,
                    context: match
                });
            });
        }
        
        return numbers;
    }

    function displayRealResults(numbers, fullText) {
        const resultsEl = document.getElementById('results-container');
        const detectedEl = document.getElementById('detected-data');
        
        let resultsHTML = '';
        
        numbers.forEach(num => {
            if (num.type === 'rpm') {
                resultsHTML += `<div>üîÑ <strong>RPM:</strong> ${num.value} <small>(encontrado: "${num.context}")</small></div>`;
            } else if (num.type === 'counter') {
                resultsHTML += `<div>üìä <strong>N√∫mero:</strong> ${num.value.toLocaleString()} <small>(encontrado: "${num.context}")</small></div>`;
            } else if (num.type === 'percentage') {
                resultsHTML += `<div>üìà <strong>Porcentaje:</strong> ${num.value}% <small>(encontrado: "${num.context}")</small></div>`;
            }
        });
        
        detectedEl.innerHTML = resultsHTML;
        resultsEl.style.display = 'block';
    }

    function updateAccumulatedData(numbers) {
        numbers.forEach(num => {
            if (num.type === 'rpm') {
                appState.accumulatedData.rpm = num.value;
                document.getElementById('inp-rpm').value = num.value;
                document.getElementById('inp-rpm').style.backgroundColor = "#d4edda";
            } else if (num.type === 'counter') {
                // Solo usar como pasadas si parece razonable para pasadas
                if (num.value < 1000000) {
                    appState.accumulatedData.picks = num.value;
                    document.getElementById('inp-picks').value = num.value;
                    document.getElementById('inp-picks').style.backgroundColor = "#d4edda";
                }
            }
        });
    }

    function displayNoNumbersFound(text) {
        const manualEl = document.getElementById('manual-input');
        manualEl.style.display = 'block';
        
        if (!document.getElementById('inp-rpm').value) {
            document.getElementById('inp-rpm').focus();
        } else if (!document.getElementById('inp-picks').value) {
            document.getElementById('inp-picks').focus();
        }
    }

    function enableManualInput() {
        hideAllResultSections();
        document.getElementById('manual-input').style.display = 'block';
        
        if (!document.getElementById('inp-rpm').value) {
            document.getElementById('inp-rpm').focus();
        } else if (!document.getElementById('inp-picks').value) {
            document.getElementById('inp-picks').focus();
        }
    }

    function clearOCRData() {
        document.getElementById('preview-container-ai').style.display = 'none';
        imgPreviewAI.src = '';
        appState.currentImageData = null;
        
        hideAllResultSections();
        
        inpFotoAI.value = '';
        inpFotoGaleria.value = '';
        
        const rpmInput = document.getElementById('inp-rpm');
        const picksInput = document.getElementById('inp-picks');
        
        rpmInput.style.backgroundColor = '';
        picksInput.style.backgroundColor = '';
        
        document.getElementById('analyze-btn').disabled = false;
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // --- EXPORTACI√ìN ---
    function exportToCSV() {
        if(appState.lecturas.length === 0) { alert("Sin datos"); return; }
        const rows = [["Fecha","Turno","Telar","RPM","Picks","Operador","Metros","Observaciones"]];
        appState.lecturas.forEach(l => rows.push([l.fecha, l.turno, l.telarId, l.rpm, l.picks, l.operador, l.metros || '', l.observaciones || '']));
        let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "telares_texcorp.csv");
        document.body.appendChild(link);
        link.click();
    }

    // Reloj y Arranque
    setInterval(() => {
        const now = new Date();
        document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);

    renderPlant();
</script>
</body>
</html>
