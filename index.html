<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura de Telares - TEXCORP Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --border-radius: 8px;
            --card-height: 160px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
            color: var(--text-main); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white; 
            padding: 16px 24px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        header small {
            opacity: 0.9;
            font-size: 0.875rem;
            display: block;
            margin-top: 2px;
        }

        #current-time {
            font-size: 1.125rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ===== CONTROLS BAR ===== */
        .controls-bar {
            background: var(--card-bg);
            padding: 20px 24px;
            display: flex;
            gap: 20px;
            align-items: flex-end;
            border-bottom: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-green {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-blue {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }

        .btn-red {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        /* ===== PLANT GRID LAYOUT (PRESERVADO) ===== */
        .plant-scroll-area {
            flex: 1;
            overflow: auto;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .plant-grid {
            display: flex;
            gap: 16px;
            min-width: 1800px;
            align-items: flex-start;
        }

        .plant-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-width: 180px;
        }

        /* ===== TELAR CARDS (MODERNIZADAS) ===== */
        .telar-card, .empty-card-space {
            height: var(--card-height);
            border-radius: 12px;
        }

        .empty-card-space {
            background: transparent;
            border: 2px dashed rgba(148, 163, 184, 0.3);
            pointer-events: none;
        }

        .telar-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .telar-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .telar-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--secondary-color);
        }

        .telar-card:hover::before {
            opacity: 1;
        }

        .card-top {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.875rem;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-bottom: 1px solid var(--border-color);
        }

        .card-status-bar {
            text-align: center;
            padding: 8px 0;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-working {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .status-paused {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .status-pending {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            color: var(--text-secondary);
        }

        .card-body {
            padding: 12px 16px;
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .card-body strong {
            display: block;
            color: var(--text-main);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-footer {
            padding: 8px 16px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            background: #f8fafc;
        }

        /* ===== MODALES MODERNOS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 16px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .full-width {
            grid-column: span 2;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            resize: vertical;
            font-family: inherit;
        }

        /* ===== OCR PANEL MODERNO ===== */
        .ocr-panel {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .ocr-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.1;
        }

        .ocr-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }

        .ocr-panel h4 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .tech-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .ocr-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
            position: relative;
            z-index: 1;
        }

        .capture-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-capture {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn-capture:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .btn-capture:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== IMAGE PREVIEW ===== */
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .preview-box {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .preview-box img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
        }

        .preview-label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        /* ===== OCR RESULTS ===== */
        .ocr-results {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 16px 0;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .result-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .result-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ===== PROCESSING INDICATOR ===== */
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            z-index: 10;
        }

        .processing-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .ocr-controls {
                grid-template-columns: 1fr;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .plant-grid {
                min-width: auto;
                flex-wrap: wrap;
            }
            
            .plant-column {
                min-width: 150px;
            }
        }

        /* ===== VIDEO STYLES ===== */
        video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 12px;
            object-fit: cover;
            background: #000;
            box-shadow: var(--shadow-lg);
        }

        #camera-video {
            transform: scaleX(-1);
        }

        /* ===== PROGRESS INDICATOR ===== */
        #progress-text {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* ===== VALIDATION ALERTS ===== */
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #059669;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #d97706;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        /* ===== HIDDEN CANVAS ===== */
        canvas {
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <div>
            <h3>Lectura de Telares Pro</h3>
            <small>TEXCORP - Planta Lima | OCR Inteligente</small>
        </div>
        <div id="current-time">--:--</div>
    </header>

    <div class="controls-bar">
        <div class="control-group">
            <label>Fecha Turno</label>
            <input type="date" id="filter-date">
        </div>
        <div class="control-group">
            <label>Turno</label>
            <select id="filter-turno">
                <option value="M">Ma√±ana</option>
                <option value="N">Noche</option>
                <option value="F">Festivo</option>
            </select>
        </div>
        <button class="btn btn-blue" onclick="toggleQRScanner()">üì± Escanear QR</button>
        
        <div style="flex-grow: 1;"></div>
        
        <button class="btn btn-green" onclick="exportToCSV()">üìä Export CSV</button>
        <button class="btn btn-green" onclick="exportToExcel()">üìà Export Excel</button>
        <div id="progress-text">0/31 Completados</div>
    </div>

    <!-- ===== QR SCANNER MODAL ===== -->
    <div id="qr-overlay" class="modal-overlay" style="z-index: 1100;">
        <div class="modal-content" style="background: transparent; box-shadow: none; text-align: center;">
            <div id="qr-video-container" style="display: block;">
                <video id="qr-video" playsinline></video>
                <div style="margin-top: 16px; color: white; font-weight: 600; font-size: 1.125rem;">
                    üéØ Apunte al c√≥digo QR del telar
                </div>
                <button class="btn btn-red" style="margin-top: 20px;" onclick="stopQRScanner()">
                    Cerrar C√°mara
                </button>
            </div>
        </div>
    </div>

    <!-- ===== CAMERA CAPTURE MODAL ===== -->
    <div id="camera-overlay" class="modal-overlay" style="z-index: 1200;">
        <div class="modal-content" style="background: transparent; box-shadow: none; text-align: center;">
            <div id="camera-modal-content" style="display: block;">
                <video id="camera-video" playsinline></video>
                <div style="margin-top: 16px; color: white; font-weight: 600; font-size: 1.125rem;">
                    üì∏ Enfoca la pantalla del telar
                </div>
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px;">
                    <button class="btn btn-green" onclick="capturePhoto()">üì∏ Capturar</button>
                    <button class="btn btn-red" onclick="stopCamera()">‚ùå Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TELAR PLANT GRID ===== -->
    <div class="plant-scroll-area">
        <div class="plant-grid" id="plant-grid">
            <!-- Grid generado din√°micamente -->
        </div>
    </div>

    <!-- ===== TELAR REGISTRATION MODAL ===== -->
    <div class="modal-overlay" id="modal-registro">
        <div class="modal-content">
            <h2 id="modal-title" style="color: var(--primary-color); margin-bottom: 8px;">Registro de Telar</h2>
            <p id="modal-subtitle" style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color);"></p>
            
            <form id="form-lectura">
                
                <!-- ===== OCR PANEL ===== -->
                <div class="ocr-panel">
                    <div class="processing-overlay" id="ocr-processing">
                        <div class="processing-content">
                            <div class="spinner"></div>
                            <div id="processing-text">Procesando imagen...</div>
                        </div>
                    </div>
                    
                    <div class="ocr-panel-header">
                        <h4>ü§ñ OCR Inteligente</h4>
                        <span class="tech-badge">Tesseract v5</span>
                    </div>
                    
                    <p style="opacity: 0.8; margin-bottom: 16px; font-size: 0.875rem;">
                        Sistema avanzado de reconocimiento √≥ptico con pre-procesamiento inteligente y validaci√≥n autom√°tica.
                    </p>
                    
                    <div class="ocr-controls">
                        <div class="capture-section">
                            <h5 style="margin-bottom: 8px; font-size: 0.875rem;">üì∏ Captura</h5>
                            <button type="button" class="btn-capture" onclick="startCamera()">
                                üì± Abrir C√°mara
                            </button>
                            <input type="file" id="file-upload" accept="image/*" style="display: none;">
                            <button type="button" class="btn-capture" onclick="document.getElementById('file-upload').click()">
                                üìÅ Subir Imagen
                            </button>
                        </div>
                        
                        <div class="capture-section">
                            <h5 style="margin-bottom: 8px; font-size: 0.875rem;">‚ö° Procesamiento</h5>
                            <button type="button" class="btn-capture" id="btn-process" onclick="runIntelligentOCR()" disabled>
                                üß† Analizar Imagen
                            </button>
                            <button type="button" class="btn-capture" onclick="clearOCRSession()">
                                üóëÔ∏è Limpiar Todo
                            </button>
                        </div>
                    </div>
                    
                    <div class="preview-grid" id="preview-grid" style="display: none;">
                        <div class="preview-box">
                            <div class="preview-label">Original</div>
                            <img id="img-original" alt="Imagen original">
                        </div>
                        <div class="preview-box">
                            <div class="preview-label">Procesada</div>
                            <img id="img-processed" alt="Imagen procesada">
                        </div>
                    </div>
                    
                    <div class="ocr-results" id="ocr-results">
                        <h5 style="margin-bottom: 12px; color: #10b981;">‚ú® Resultados Detectados</h5>
                        <div class="results-grid">
                            <div class="result-item">
                                <div class="result-value" id="result-rpm">--</div>
                                <div class="result-label">RPM</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value" id="result-picks">--</div>
                                <div class="result-label">Pasadas</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value" id="result-eff">--</div>
                                <div class="result-label">Eficiencia</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value" id="result-metros">--</div>
                                <div class="result-label">Metros</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ===== VALIDATION ALERTS ===== -->
                <div id="validation-alerts"></div>
                
                <!-- ===== FORM FIELDS ===== -->
                <div class="form-grid">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Operador</label>
                        <input type="text" id="inp-operador" placeholder="Nombre del operador" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">RPM</label>
                        <input type="number" id="inp-rpm" placeholder="0" min="0" max="1200" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Pasadas / Picks</label>
                        <input type="number" id="inp-picks" placeholder="0" min="0" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Metros</label>
                        <input type="number" id="inp-metros" placeholder="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Eficiencia (%)</label>
                        <input type="number" id="inp-eficiencia" placeholder="0-100" min="0" max="100">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Defectos</label>
                        <input type="number" id="inp-defectos" placeholder="0" min="0">
                    </div>
                    <div class="full-width">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">Observaciones</label>
                        <textarea id="inp-observaciones" placeholder="Notas adicionales sobre el telar..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; margin-top: 32px; justify-content: flex-end;">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-blue">üíæ Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== HIDDEN PROCESSING CANVAS ===== -->
    <canvas id="processing-canvas"></canvas>

<script>
    // ===== ESTADO DE LA APLICACI√ìN =====
    const telares = [
        {id: 1, pos: [0,0]}, {id: 2, pos: [0,1]}, {id: 3, pos: [0,2]}, {id: 4, pos: [0,3]},
        {id: 5, pos: [1,0]}, {id: 6, pos: [1,1]}, {id: 7, pos: [1,2]}, {id: 8, pos: [1,3]},
        {id: 9, pos: [2,0]}, {id: 10, pos: [2,1]}, {id: 11, pos: [2,2]}, {id: 12, pos: [2,3]},
        {id: 13, pos: [3,0]}, {id: 14, pos: [3,1]}, {id: 15, pos: [3,2]}, {id: 16, pos: [3,3]},
        {id: 17, pos: [4,0]}, {id: 18, pos: [4,1]}, {id: 19, pos: [4,2]}, {id: 20, pos: [4,3]},
        {id: 21, pos: [5,0]}, {id: 22, pos: [5,1]}, {id: 23, pos: [5,2]}, {id: 24, pos: [5,3]},
        {id: 25, pos: [6,0]}, {id: 26, pos: [6,1]}, {id: 27, pos: [6,2]}, {id: 28, pos: [6,3]},
        {id: 29, pos: [7,0]}, {id: 30, pos: [7,1]}, {id: 31, pos: [8,0]}
    ];

    const appState = {
        fecha: new Date().toISOString().split('T')[0],
        turno: 'M',
        lecturas: JSON.parse(localStorage.getItem('lecturasTexcorpPro') || '[]'),
        operador: localStorage.getItem('lastOperador') || '',
        selectedTelar: null,
        currentImageData: null,
        processedImageData: null
    };

    // ===== ELEMENTOS DOM =====
    const elements = {
        date: document.getElementById('filter-date'),
        turno: document.getElementById('filter-turno'),
        operador: document.getElementById('inp-operador'),
        fileUpload: document.getElementById('file-upload'),
        imgOriginal: document.getElementById('img-original'),
        imgProcessed: document.getElementById('img-processed'),
        btnProcess: document.getElementById('btn-process'),
        previewGrid: document.getElementById('preview-grid'),
        ocrResults: document.getElementById('ocr-results'),
        ocrProcessing: document.getElementById('ocr-processing'),
        validationAlerts: document.getElementById('validation-alerts')
    };

    // ===== INICIALIZACI√ìN =====
    elements.date.value = appState.fecha;
    elements.turno.value = appState.turno;
    elements.operador.value = appState.operador;

    // Event Listeners
    elements.date.addEventListener('change', (e) => { 
        appState.fecha = e.target.value; 
        renderPlant(); 
    });
    
    elements.turno.addEventListener('change', (e) => { 
        appState.turno = e.target.value; 
        renderPlant(); 
    });

    elements.fileUpload.addEventListener('change', handleFileUpload);

    // ===== RENDER PLANT (PRESERVANDO LAYOUT ORIGINAL) =====
    function renderPlant() {
        const grid = document.getElementById('plant-grid');
        grid.innerHTML = '';

        // Crear 9 columnas exactamente como en ef8_.html
        for(let col = 0; col < 9; col++) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'plant-column';
            
            // 4 filas por columna
            for(let row = 0; row < 4; row++) {
                const telar = telares.find(t => t.pos[0] === col && t.pos[1] === row);
                
                if(telar) {
                    const lectura = appState.lecturas.find(l => 
                        l.telarId === telar.id && 
                        l.fecha === appState.fecha && 
                        l.turno === appState.turno
                    );
                    
                    const card = document.createElement('div');
                    card.className = 'telar-card';
                    card.onclick = () => openModal(telar.id);
                    
                    const status = getTelarStatus(lectura);
                    const efficiency = lectura?.eficiencia ? `${lectura.eficiencia}%` : '?';
                    
                    card.innerHTML = `
                        <div class="card-top">
                            <span>TELAR ${telar.id}</span>
                            <span style="color: var(--secondary-color);">${lectura ? lectura.rpm + ' RPM' : '--'}</span>
                        </div>
                        <div class="card-status-bar ${status.class}">${status.text}</div>
                        <div class="card-body">
                            <strong>${lectura ? new Intl.NumberFormat().format(lectura.picks) + ' picks' : 'Sin lecturas'}</strong>
                            <div>${lectura ? `${lectura.operador} | Eff: ${efficiency}` : 'Pendiente de registro'}</div>
                        </div>
                        <div class="card-footer">
                            ${lectura ? `Metros: ${lectura.metros || 0} | Defectos: ${lectura.defectos || 0}` : 'No registrado'}
                        </div>
                    `;
                    columnDiv.appendChild(card);
                } else {
                    // Espacios vac√≠os para mantener el grid
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'empty-card-space';
                    columnDiv.appendChild(emptyCard);
                }
            }
            grid.appendChild(columnDiv);
        }

        updateProgressCounter();
    }

    function getTelarStatus(lectura) {
        if (!lectura) return { class: 'status-pending', text: 'SIN DATOS' };
        if (lectura.rpm > 0) return { class: 'status-working', text: 'TRABAJANDO' };
        return { class: 'status-paused', text: 'PARADO' };
    }

    function updateProgressCounter() {
        const completadas = appState.lecturas.filter(l => 
            l.fecha === appState.fecha && l.turno === appState.turno
        ).length;
        document.getElementById('progress-text').textContent = `${completadas}/31 Completados`;
    }

    // ===== MODAL CONTROLS =====
    function openModal(telarId) {
        appState.selectedTelar = telarId;
        const modal = document.getElementById('modal-registro');
        
        document.getElementById('modal-title').textContent = `Registro Telar ${telarId}`;
        document.getElementById('modal-subtitle').textContent = 
            `üìÖ ${appState.fecha} | ‚è∞ Turno ${appState.turno}`;
        
        // Cargar datos existentes si los hay
        loadExistingData(telarId);
        
        // Limpiar sesi√≥n OCR
        clearOCRSession();
        
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-registro').style.display = 'none';
        appState.selectedTelar = null;
        clearOCRSession();
    }

    function loadExistingData(telarId) {
        const lectura = appState.lecturas.find(l => 
            l.telarId === telarId && 
            l.fecha === appState.fecha && 
            l.turno === appState.turno
        );

        if (lectura) {
            document.getElementById('inp-operador').value = lectura.operador;
            document.getElementById('inp-rpm').value = lectura.rpm;
            document.getElementById('inp-picks').value = lectura.picks;
            document.getElementById('inp-metros').value = lectura.metros || '';
            document.getElementById('inp-eficiencia').value = lectura.eficiencia || '';
            document.getElementById('inp-defectos').value = lectura.defectos || '';
            document.getElementById('inp-observaciones').value = lectura.observaciones || '';
        } else {
            document.getElementById('form-lectura').reset();
            document.getElementById('inp-operador').value = appState.operador;
        }
    }

    // ===== FORM SUBMISSION =====
    document.getElementById('form-lectura').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = collectFormData();
        
        if (!validateFormData(formData)) return;
        
        saveTelarData(formData);
        closeModal();
        renderPlant();
    });

    function collectFormData() {
        return {
            telarId: appState.selectedTelar,
            fecha: appState.fecha,
            turno: appState.turno,
            operador: document.getElementById('inp-operador').value.trim(),
            rpm: parseInt(document.getElementById('inp-rpm').value) || 0,
            picks: parseInt(document.getElementById('inp-picks').value) || 0,
            metros: parseFloat(document.getElementById('inp-metros').value) || 0,
            eficiencia: parseFloat(document.getElementById('inp-eficiencia').value) || null,
            defectos: parseInt(document.getElementById('inp-defectos').value) || 0,
            observaciones: document.getElementById('inp-observaciones').value.trim(),
            timestamp: new Date().toISOString()
        };
    }

    function validateFormData(data) {
        const errors = [];
        
        if (!data.operador) {
            errors.push({ type: 'error', message: 'El nombre del operador es obligatorio' });
        }
        
        if (data.rpm === 0) {
            errors.push({ type: 'error', message: 'RPM no puede ser 0' });
        }
        
        if (data.picks === 0) {
            errors.push({ type: 'error', message: 'Las pasadas no pueden ser 0' });
        }
        
        if (data.rpm > 1200) {
            errors.push({ type: 'warning', message: 'RPM muy alto, verificar lectura' });
        }
        
        if (data.eficiencia && (data.eficiencia < 30 || data.eficiencia > 100)) {
            errors.push({ type: 'warning', message: 'Eficiencia fuera del rango normal (30-100%)' });
        }
        
        showValidationAlerts(errors);
        
        return errors.filter(e => e.type === 'error').length === 0;
    }

    function saveTelarData(data) {
        const existingIndex = appState.lecturas.findIndex(l => 
            l.telarId === data.telarId && 
            l.fecha === data.fecha && 
            l.turno === data.turno
        );

        if (existingIndex >= 0) {
            appState.lecturas[existingIndex] = data;
        } else {
            appState.lecturas.push(data);
        }

        localStorage.setItem('lecturasTexcorpPro', JSON.stringify(appState.lecturas));
        localStorage.setItem('lastOperador', data.operador);
        appState.operador = data.operador;
    }

    // ===== OCR SYSTEM =====
    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            const img = new Image();
            img.onload = function() {
                appState.currentImageData = img;
                elements.imgOriginal.src = evt.target.result;
                
                showPreviewGrid();
                preprocessImage(img);
                elements.btnProcess.disabled = false;
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    function preprocessImage(img) {
        const canvas = document.getElementById('processing-canvas');
        const ctx = canvas.getContext('2d');

        // Redimensionar para OCR √≥ptimo
        const targetWidth = 1000;
        const scale = targetWidth / img.width;
        canvas.width = targetWidth;
        canvas.height = img.height * scale;

        // Dibujar imagen escalada
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Aplicar filtros avanzados
        applyAdvancedFilters(ctx, canvas.width, canvas.height);
        
        // Mostrar imagen procesada
        elements.imgProcessed.src = canvas.toDataURL();
        appState.processedImageData = canvas;
    }

    function applyAdvancedFilters(ctx, width, height) {
        let imageData = ctx.getImageData(0, 0, width, height);
        let data = imageData.data;

        // 1. CONVERSI√ìN A ESCALA DE GRISES OPTIMIZADA
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            // F√≥rmula optimizada para pantallas LCD
            const gray = 0.299 * r + 0.587 * g + 0.114 * b;

            data[i] = gray;
            data[i + 1] = gray;
            data[i + 2] = gray;
        }

        // 2. FILTRO DE CONTRASTE ADAPTATIVO
        const threshold = calculateAdaptiveThreshold(data);
        
        // 3. BINARIZACI√ìN CON THRESHOLD DIN√ÅMICO
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i];
            const val = gray < threshold ? 0 : 255;

            data[i] = val;
            data[i + 1] = val;
            data[i + 2] = val;
        }

        // 4. FILTRO DE RUIDO (MEDIAN FILTER SIMPLIFICADO)
        const filteredData = applyNoiseReduction(data, width, height);
        
        ctx.putImageData(new ImageData(filteredData, width, height), 0, 0);
    }

    function calculateAdaptiveThreshold(data) {
        const histogram = new Array(256).fill(0);
        
        // Crear histograma
        for (let i = 0; i < data.length; i += 4) {
            const gray = Math.round(data[i]);
            histogram[gray]++;
        }

        // M√©todo de Otsu simplificado
        const totalPixels = data.length / 4;
        let sum = 0;
        
        for (let i = 0; i < 256; i++) {
            sum += i * histogram[i];
        }

        let sumB = 0;
        let wB = 0;
        let wF = 0;
        let maxVariance = 0;
        let threshold = 0;

        for (let i = 0; i < 256; i++) {
            wB += histogram[i];
            if (wB === 0) continue;

            wF = totalPixels - wB;
            if (wF === 0) break;

            sumB += i * histogram[i];

            const mB = sumB / wB;
            const mF = (sum - sumB) / wF;

            const variance = wB * wF * Math.pow(mB - mF, 2);

            if (variance > maxVariance) {
                maxVariance = variance;
                threshold = i;
            }
        }

        // Ajustar threshold para pantallas de telar
        return Math.max(80, Math.min(160, threshold));
    }

    function applyNoiseReduction(data, width, height) {
        const filtered = new Uint8ClampedArray(data);
        
        // Aplicar filtro mediano 3x3 simplificado
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                
                // Recoger valores vecinos
                const neighbors = [];
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nIdx = ((y + dy) * width + (x + dx)) * 4;
                        neighbors.push(data[nIdx]);
                    }
                }
                
                // Mediana
                neighbors.sort((a, b) => a - b);
                const median = neighbors[4];
                
                filtered[idx] = median;
                filtered[idx + 1] = median;
                filtered[idx + 2] = median;
            }
        }
        
        return filtered;
    }

    async function runIntelligentOCR() {
        if (!appState.processedImageData) {
            showAlert('error', 'No hay imagen procesada para analizar');
            return;
        }

        showProcessing(true);

        try {
            // Configuraci√≥n avanzada de Tesseract
            const { data: { text } } = await Tesseract.recognize(
                appState.processedImageData,
                'eng', // Ingl√©s funciona mejor para n√∫meros
                {
                    tessedit_char_whitelist: '0123456789.rpm%MPasdnsETxurlconetriby',
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    preserve_interword_spaces: '1',
                    logger: updateProcessingProgress
                }
            );

            const results = parseIntelligentResults(text);
            displayOCRResults(results);
            updateFormFields(results);
            validateAndShowAlerts(results);

        } catch (error) {
            console.error('OCR Error:', error);
            showAlert('error', 'Error en el procesamiento OCR: ' + error.message);
        } finally {
            showProcessing(false);
        }
    }

    function parseIntelligentResults(text) {
        console.log('Texto OCR crudo:', text);
        
        // Limpiar texto con correcciones inteligentes
        const cleanText = text
            .replace(/[O|o|Q]/g, '0')
            .replace(/[S|s|¬ß]/g, '5')
            .replace(/[l|I|1|!]/g, '1')
            .replace(/[Z]/g, '2')
            .replace(/[G|6]/g, '6')
            .replace(/[B]/g, '8')
            .toLowerCase();

        const results = {
            rpm: null,
            picks: null,
            eficiencia: null,
            metros: null,
            confidence: { rpm: 0, picks: 0, eficiencia: 0, metros: 0 }
        };

        const lines = cleanText.split(/[\n\r]+/).filter(line => line.trim());

        lines.forEach((line, index) => {
            console.log(`L√≠nea ${index}: "${line}"`);

            // DETECCI√ìN RPM INTELIGENTE
            if (!results.rpm && (line.includes('rpm') || /\d+\s*r[pm]/.test(line))) {
                const rpmMatch = line.match(/(\d{2,4})\s*r?p?m?/i);
                if (rpmMatch) {
                    const val = parseInt(rpmMatch[1]);
                    if (val >= 50 && val <= 1200) {
                        results.rpm = val;
                        results.confidence.rpm = 90;
                        console.log(`‚úÖ RPM detectadas: ${val}`);
                    }
                }
            }

            // DETECCI√ìN EFICIENCIA
            if (!results.eficiencia && (line.includes('%') || line.includes('eff'))) {
                const effMatch = line.match(/(\d{1,3}(?:\.\d+)?)\s*%?/);
                if (effMatch) {
                    const val = parseFloat(effMatch[1]);
                    if (val > 0 && val <= 100) {
                        results.eficiencia = val;
                        results.confidence.eficiencia = 85;
                        console.log(`‚úÖ Eficiencia detectada: ${val}%`);
                    }
                }
            }

            // DETECCI√ìN METROS
            if (!results.metros && (line.includes('metro') || line.includes('preselec'))) {
                const metrosMatch = line.match(/(\d{3,6})/);
                if (metrosMatch) {
                    const val = parseInt(metrosMatch[1]);
                    if (val > 0 && val < 100000) {
                        results.metros = val;
                        results.confidence.metros = 80;
                        console.log(`‚úÖ Metros detectados: ${val}`);
                    }
                }
            }

            // DETECCI√ìN PASADAS/PICKS INTELIGENTE
            const numbers = line.match(/\d{4,8}/g);
            if (numbers && !results.picks) {
                numbers.forEach(numStr => {
                    const num = parseInt(numStr);
                    
                    // L√≥gica inteligente para distinguir pasadas de contadores
                    if (num >= 1000 && num <= 999999) { // Rango t√≠pico de pasadas
                        // Preferir n√∫meros m√°s peque√±os (pasadas) sobre n√∫meros muy grandes (contadores)
                        if (num < 500000) {
                            results.picks = num;
                            results.confidence.picks = 95;
                            console.log(`‚úÖ Pasadas detectadas: ${num}`);
                        } else if (!results.picks) {
                            // Si no hay alternativa mejor, usar n√∫mero grande pero con menos confianza
                            results.picks = num;
                            results.confidence.picks = 60;
                            console.log(`‚ö†Ô∏è Posibles pasadas (n√∫mero alto): ${num}`);
                        }
                    }
                });
            }
        });

        return results;
    }

    function displayOCRResults(results) {
        document.getElementById('result-rpm').textContent = results.rpm || '--';
        document.getElementById('result-picks').textContent = 
            results.picks ? results.picks.toLocaleString() : '--';
        document.getElementById('result-eff').textContent = 
            results.eficiencia ? results.eficiencia + '%' : '--';
        document.getElementById('result-metros').textContent = results.metros || '--';

        elements.ocrResults.style.display = 'block';
    }

    function updateFormFields(results) {
        const fields = [
            { id: 'inp-rpm', value: results.rpm },
            { id: 'inp-picks', value: results.picks },
            { id: 'inp-eficiencia', value: results.eficiencia },
            { id: 'inp-metros', value: results.metros }
        ];

        fields.forEach(field => {
            if (field.value) {
                const element = document.getElementById(field.id);
                element.value = field.value;
                element.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                element.style.borderColor = '#10b981';
            }
        });
    }

    function validateAndShowAlerts(results) {
        const alerts = [];

        if (results.rpm && (results.rpm < 100 || results.rpm > 1000)) {
            alerts.push({
                type: 'warning',
                message: `‚ö†Ô∏è RPM ${results.rpm} fuera del rango t√≠pico (100-1000)`
            });
        }

        if (results.picks && results.picks > 500000) {
            alerts.push({
                type: 'warning',
                message: `‚ö†Ô∏è N√∫mero de pasadas alto (${results.picks.toLocaleString()}). ¬øEs contador acumulativo?`
            });
        }

        if (results.eficiencia && (results.eficiencia < 30 || results.eficiencia > 100)) {
            alerts.push({
                type: 'warning',
                message: `‚ö†Ô∏è Eficiencia ${results.eficiencia}% fuera del rango normal`
            });
        }

        if (!results.rpm && !results.picks) {
            alerts.push({
                type: 'error',
                message: '‚ùå No se detectaron valores principales. Verificar calidad de imagen.'
            });
        } else {
            alerts.push({
                type: 'success',
                message: '‚úÖ Datos extra√≠dos exitosamente. Revisar antes de guardar.'
            });
        }

        showValidationAlerts(alerts);
    }

    // ===== UI HELPER FUNCTIONS =====
    function showProcessing(show) {
        elements.ocrProcessing.style.display = show ? 'flex' : 'none';
        elements.btnProcess.disabled = show;
    }

    function updateProcessingProgress(m) {
        if (m.status === 'recognizing text') {
            const progress = Math.round(m.progress * 100);
            document.getElementById('processing-text').textContent = 
                `Reconociendo texto... ${progress}%`;
        }
    }

    function showPreviewGrid() {
        elements.previewGrid.style.display = 'grid';
    }

    function clearOCRSession() {
        // Reset UI elements
        elements.previewGrid.style.display = 'none';
        elements.ocrResults.style.display = 'none';
        elements.validationAlerts.innerHTML = '';
        elements.btnProcess.disabled = true;
        elements.fileUpload.value = '';

        // Reset form field styles
        const fieldIds = ['inp-rpm', 'inp-picks', 'inp-eficiencia', 'inp-metros'];
        fieldIds.forEach(id => {
            const element = document.getElementById(id);
            element.style.background = '';
            element.style.borderColor = '';
        });

        // Reset state
        appState.currentImageData = null;
        appState.processedImageData = null;
    }

    function showValidationAlerts(alerts) {
        elements.validationAlerts.innerHTML = '';
        
        alerts.forEach(alert => {
            const div = document.createElement('div');
            div.className = `alert alert-${alert.type}`;
            div.innerHTML = alert.message;
            elements.validationAlerts.appendChild(div);
        });
    }

    function showAlert(type, message) {
        showValidationAlerts([{ type, message }]);
    }

    // ===== CAMERA FUNCTIONS =====
    let camVideo = document.getElementById('camera-video');
    let camStream = null;

    async function startCamera() {
        const overlay = document.getElementById('camera-overlay');
        overlay.style.display = 'flex';
        
        try {
            camStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            camVideo.srcObject = camStream;
            camVideo.play();
        } catch(err) {
            showAlert('error', 'Error al acceder a la c√°mara');
            overlay.style.display = 'none';
        }
    }

    function stopCamera() {
        const overlay = document.getElementById('camera-overlay');
        if(camStream) {
            camStream.getTracks().forEach(track => track.stop());
            camStream = null;
        }
        overlay.style.display = 'none';
    }

    function capturePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = camVideo.videoWidth;
        canvas.height = camVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Capturar imagen del video
        ctx.scale(-1, 1); // Deshacer el flip
        ctx.drawImage(camVideo, -canvas.width, 0, canvas.width, canvas.height);
        
        const dataUrl = canvas.toDataURL('image/png');
        
        // Procesar como si fuera un archivo subido
        const img = new Image();
        img.onload = function() {
            appState.currentImageData = img;
            elements.imgOriginal.src = dataUrl;
            
            showPreviewGrid();
            preprocessImage(img);
            elements.btnProcess.disabled = false;
        };
        img.src = dataUrl;
        
        stopCamera();
    }

    // ===== QR SCANNER (PRESERVADO) =====
    let qrVideo = document.getElementById('qr-video');
    let qrStream = null;
    let isQRScanning = false;

    async function toggleQRScanner() {
        const overlay = document.getElementById('qr-overlay');
        if(isQRScanning) { 
            stopQRScanner(); 
            return; 
        }

        overlay.style.display = 'flex';
        try {
            qrStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            qrVideo.srcObject = qrStream;
            qrVideo.play();
            isQRScanning = true;
            requestAnimationFrame(tickQR);
        } catch(err) {
            showAlert('error', 'No se pudo acceder a la c√°mara para QR');
            overlay.style.display = 'none';
        }
    }

    function stopQRScanner() {
        const overlay = document.getElementById('qr-overlay');
        if(qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }
        isQRScanning = false;
        overlay.style.display = 'none';
    }

    function tickQR() {
        if(!isQRScanning) return;
        if(qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas");
            canvas.width = qrVideo.videoWidth;
            canvas.height = qrVideo.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if(code) {
                const numbers = code.data.match(/\d+/);
                if(numbers) {
                    const id = parseInt(numbers[0]);
                    if(telares.find(t => t.id === id)) {
                        stopQRScanner();
                        openModal(id);
                        return;
                    }
                }
            }
        }
        requestAnimationFrame(tickQR);
    }

    // ===== EXPORT FUNCTIONS =====
    function exportToCSV() {
        if(appState.lecturas.length === 0) { 
            showAlert('warning', 'No hay datos para exportar');
            return; 
        }
        
        const headers = ["Fecha","Turno","Telar","Operador","RPM","Picks","Metros","Eficiencia","Defectos","Observaciones"];
        const rows = [headers];
        
        appState.lecturas.forEach(l => {
            rows.push([
                l.fecha, l.turno, l.telarId, l.operador, l.rpm, l.picks, 
                l.metros || 0, l.eficiencia || '', l.defectos || 0, l.observaciones || ''
            ]);
        });
        
        const csvContent = "data:text/csv;charset=utf-8," + 
                          rows.map(row => row.map(field => `"${field}"`).join(",")).join("\n");
        
        downloadFile(csvContent, `telares_texcorp_${appState.fecha}.csv`);
    }

    function exportToExcel() {
        if(appState.lecturas.length === 0) { 
            showAlert('warning', 'No hay datos para exportar');
            return; 
        }
        
        let table = '<table border="1"><thead><tr>';
        table += '<th>Fecha</th><th>Turno</th><th>Telar</th><th>Operador</th><th>RPM</th>';
        table += '<th>Picks</th><th>Metros</th><th>Eficiencia</th><th>Defectos</th><th>Observaciones</th>';
        table += '</tr></thead><tbody>';
        
        appState.lecturas.forEach(l => {
            table += `<tr>
                <td>${l.fecha}</td><td>${l.turno}</td><td>${l.telarId}</td><td>${l.operador}</td>
                <td>${l.rpm}</td><td>${l.picks}</td><td>${l.metros || 0}</td>
                <td>${l.eficiencia || ''}</td><td>${l.defectos || 0}</td>
                <td>${l.observaciones || ''}</td>
            </tr>`;
        });
        table += '</tbody></table>';
        
        const blob = new Blob(['\ufeff' + table], { type: 'application/vnd.ms-excel' });
        const url = window.URL.createObjectURL(blob);
        
        downloadFile(url, `telares_texcorp_${appState.fecha}.xls`);
        window.URL.revokeObjectURL(url);
    }

    function downloadFile(content, filename) {
        const link = document.createElement("a");
        link.setAttribute("href", content);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ===== INITIALIZATION =====
    function initializeApp() {
        renderPlant();
        
        // Update time every second
        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
        
        console.log('üöÄ TEXCORP Telares Pro initialized');
    }

    // Start the application
    initializeApp();

</script>
</body>
</html>
